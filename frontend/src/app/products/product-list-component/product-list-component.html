<div class="p-10 max-w-6xl mx-auto">
  <mat-card *appIfAdmin class="p-6 shadow-lg">
    <h1 class="font-bold text-3xl mb-8">Cadastro de produtos</h1>
    <form [formGroup]="form" (ngSubmit)="submit()" class="md:flex-row lg:flex-row gap-6">
      <div class="flex gap-4 w-full">
        <!-- Campo name -->
        <div class="mb-8 w-3/5">
          <mat-form-field [hideRequiredMarker]=false class="w-full">
            <mat-label>Nome</mat-label>
            <input matInput type="text"
                  id="name"
                  name="name"
                  formControlName="name"
                  required
            />
          </mat-form-field>
          @if (form.get('name')?.hasError('required') && form.get('name')?.touched) {
              <span class="text-red-500 text-sm">
                Campo obrigatório
              </span>
            }
            @if (form.get('name')?.hasError('minlength') && form.get('name')?.touched) {
              <span class="text-red-500 text-sm">
                Esse campo deve ter no mínimo 2 caracteres
              </span>
            }
        </div>

        <!-- Campo value -->
        <div class="mb-8 w-2/5">
          <mat-form-field [hideRequiredMarker]=false class="w-full">
            <mat-label>Preço</mat-label>
            <input matInput type="text"
                  id="value"
                  name="value"
                  formControlName="value"
                  (input)="formatCurrency($event)"
                  placeholder="R$ 0,00"
                  required
            />
          </mat-form-field>
          @if (form.get('value')?.hasError('required') && form.get('value')?.touched) {
            <span class="text-red-500 text-sm">
              Campo obrigatório
            </span>
          }
          @if (form.get('value')?.hasError('min') && form.get('value')?.touched) {
            <span class="text-red-500 text-sm">
              Campo obrigatório
            </span>
          }
        </div>
      </div>

      <!-- Lista de insumos -->
      <div class="flex gap-6 shadow-lg rounded-xl p-6 bg-gray-100 flex flex-col lg:flex-row">
        <form [formGroup]="inputsForm" (ngSubmit)="submit()" class="flex flex-col lg:flex-row">
          <div class="flex flex-col gap-4">
            <!-- Campo selection -->
            <div class="mb-3">
              <mat-form-field class="w-full">
                <mat-label>Insumo</mat-label>
                <input matInput
                  type="text"
                  id="selectedInput"
                  name="selectedInput"
                  formControlName="selectedInput"
                  [matAutocomplete]="auto"
                />
                <mat-autocomplete
                  #auto="matAutocomplete"
                  [displayWith]="displayInput"
                  (optionSelected)="onInputSelected($event.option.value)"
                >
                  @for (input of filteredInputs; track input) {
                    <mat-option [value]="input">{{ input.name }}</mat-option>
                  }
                </mat-autocomplete>
              </mat-form-field>
            </div>

            <!-- Campo amount -->
            <div class="mb-3">
              <mat-form-field class="w-full">
                <mat-label>Quantidade (g)</mat-label>
                <input matInput 
                      type="text"
                      id="inputAmount"
                      name="inputAmount"
                      formControlName="inputAmount"
                      placeholder="0 g"
                      required
                />
              </mat-form-field>
              @if (form.get('inputAmount')?.hasError('required') && form.get('inputAmount')?.touched) {
                <span class="text-red-500 text-sm">
                  Campo obrigatório
                </span>
              }
              @if (form.get('inputAmount')?.hasError('min') && form.get('inputAmount')?.touched) {
                <span class="text-red-500 text-sm">
                  Campo obrigatório
                </span>
              }
            </div>

            <button mat-raised-button (click)="addInput()" color="primary" type="button" class="w-2/5 mx-auto lg:w-full">
              <mat-icon aria-label="Adicionar insumo" fontIcon="add"></mat-icon>Adicionar
            </button>
          </div>

        </form>

        <!-- Insumos adicionados -->
        <div class="flex-1 flex flex-col gap-3 px-10 mx-auto gap-2 w-full">
          <div class="mb-6">
            <h3 class="font-semibold text-gray-700 mb-3">Insumos adicionados:</h3>

            @if (requiredInputs.length === 0) {
              <div class="text-gray-400 italic">
                Nenhum insumo adicionado
              </div>
            }

            @for (input of requiredInputs; track $index) {
              <div class="flex justify-between items-center bg-white shadow-lg rounded-lg px-4 py-2 shadow-sm mb-1">
                <span class="font-medium px-4">
                  {{ input.name }}
                </span>

                <div class="flex items-center gap-4 px-4">
                  <span class="text-gray-600">
                    {{ input.amount }}
                  </span>
                  <button mat-icon-button *appIfAdmin color="warn" (click)="removeInput($index)">
                    <mat-icon fontIcon="delete"></mat-icon>
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
      </div>

      <div class="flex justify-end">
        <button mat-flat-button type="submit" color="accent" [disabled]="requiredInputs.length === 0" class="flex justify-end mt-5">
          Salvar
        </button>
      </div>
    </form>
  </mat-card>

  <mat-card class="p-6 shadow-lg mt-6">
    <h2 class="text-xl font-bold mb-4">Lista de Produtos</h2>

    <form [formGroup]="searchBar" class="flex flex-col md:flex-row lg:flex-row">
      <!-- Campo search -->
      <div class="mb-8 flex flex-col w-full">
        <mat-form-field>
          <mat-label>Pesquisar</mat-label>
          <input matInput type="text"
                id="search"
                name="search"
                formControlName="search"
              />
            </mat-form-field>
          </div>
      </form>

    <table mat-table [dataSource]="products" class="w-full">
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Nome</th>
        <td mat-cell *matCellDef="let product">{{ product.name }}</td>
      </ng-container>

      <ng-container matColumnDef="value">
        <th mat-header-cell *matHeaderCellDef>Preço</th>
        <td mat-cell *matCellDef="let product">{{ product.value | currency:'BRL' }}</td>
      </ng-container>

      <ng-container matColumnDef="maxProduction">
        <th mat-header-cell *matHeaderCellDef>Quantidade possível</th>
        <td mat-cell *matCellDef="let product">{{ product.maxProduction }}</td>
      </ng-container>

      <ng-container matColumnDef="totalValue">
        <th mat-header-cell *matHeaderCellDef>Valor total</th>
        <td mat-cell *matCellDef="let product">{{ product.totalValue | currency:'BRL' }}</td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let product" class="">
          <button mat-icon-button color="primary" (click)="edit(product.id)">
            <mat-icon aria-label="Exibir detalhes" fontIcon="more_vert"></mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>

    <mat-paginator
      [length]="totalElements"
      [pageSize]="pageSize"
      [pageSizeOptions]="[5,10,20]"
      (page)="onPageChange($event)">
    </mat-paginator>

  </mat-card>
</div>
